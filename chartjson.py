#!/usr/bin/env python3
# Description: Loops through json generated by maps2json to build json for charts
# Author: Tyler "-z-" Mulligan

import json, copy, datetime, math
from collections import OrderedDict
from operator import itemgetter

def main():
    f = open('./resources/data/maps.json') 
    data = f.read()
    maps_json = json.loads(data)['data']

    filesizes = ['bytes']
    mapinfos = 0
    mapshots = 0
    maps = 0
    radars = 0
    waypoints = 0
    licenses = 0

    # Generate OrderedDict for filesize distribution
    filesize_dist_keys = ['<1MB']
    for i in range(1,31):
         filesize_dist_keys.append(str(i) + "MB")
    filesize_dist_keys.append('30MB+')
    filesize_dist = OrderedDict([(k, 0) for k in filesize_dist_keys])

    # Generat dict for maps by year
    years = list(range(1999,2016))
    maps_by_year = dict.fromkeys(years, 0)

    # Used for pushing all lists from all mapinfos into before making a set
    gametypes_combined = []

    # shadupes
    shadupes = {}

    # files by year
    files = [ 'mapinfo', 'mapshot', 'map', 'radar', 'waypoints', 'license' ]
    #files_by_year = dict.fromkeys(files, dict.fromkeys(years, 0))
    files_by_year = { key: dict.fromkeys(years, 0) for key in files}

    total = 0
    for m in maps_json:
        total += 1

        dt = datetime.datetime.fromtimestamp(m['date'])
        year = dt.year

        # shadupes
        if m['shasum'] in shadupes:
            shadupes[m['shasum']].append(m['pk3'])
        else:
            shadupes[m['shasum']] = [m['pk3']]

        # Pie chart data        
        if m['mapinfo']:
            mapinfos += 1
            #print(year)
            files_by_year['mapinfo'][year] += 1
            #print(files_by_year['mapinfo'][year])
        if m['mapshot']:
            mapshots += 1
            files_by_year['mapshot'][year] += 1
        if m['map']:
            maps += 1
            files_by_year['map'][year] += 1
        if m['radar']:
            radars += 1
            files_by_year['radar'][year] += 1
        if m['waypoints']:
            waypoints += 1
            files_by_year['waypoints'][year] += 1
        if m['license']:
            licenses += 1
            files_by_year['license'][year] += 1

        # Filesize distribution (stupid hacky way - please help me rewrite)
        filesize = convertSize(m['filesize'])
        if (filesize.find('KB') > -1):
            filesize_dist['<1MB'] += 1
        elif (filesize.find('MB') > -1):
            fsi = filesize.replace('MB','').strip()
            if int(fsi) > 30:
                filesize_dist['30MB+'] += 1
            else:
                filesize_dist[filesize.strip()] += 1

        # Maps over time data
        maps_by_year[year] += 1

        # Get all gametypes
        if len(m['gametypes']):
            gametypes_combined.extend(m['gametypes'])
    
    # Gametype distribution    
    gametypes_set = set(gametypes_combined)
    gametypes_dist = dict.fromkeys(gametypes_set, 0)
    gametypes_dist.pop('', None) # someone defined an empty gametype
    for m in maps_json:
        if len(m['gametypes']):
            for g in m['gametypes']:
                if g != '': # handle that empty gametype
                    gametypes_dist[g] += 1

    shadupes_sum = {}
    for key, value in shadupes.items():
        shadupes_sum[key] = len(value)

    shadupes_dist_keys = set(shadupes_sum.values())
    shadupes_dist = dict.fromkeys(shadupes_dist_keys, 0)
    for key, value in shadupes_sum.items():
        shadupes_dist[value] += 1

    # Pie Charts
    tchart = { 'bindto': '', 'data': { 'columns': [ ['yes'], ['no'] ], 'type': 'pie' } }

    c0 = copy.deepcopy(tchart)
    c0['bindto'] = '#chart-mapinfos'
    c0['data']['columns'][0].append(mapinfos)
    c0['data']['columns'][1].append(total - mapinfos)

    c1 = copy.deepcopy(tchart)
    c1['bindto'] = '#chart-mapshots'
    c1['data']['columns'][0].append(mapshots)
    c1['data']['columns'][1].append(total - mapshots)

    c2 = copy.deepcopy(tchart)
    c2['bindto'] = '#chart-maps'
    c2['data']['columns'][0].append(maps)
    c2['data']['columns'][1].append(total - maps)

    c3 = copy.deepcopy(tchart)
    c3['bindto'] = '#chart-radars'
    c3['data']['columns'][0].append(radars)
    c3['data']['columns'][1].append(total - radars)

    c4 = copy.deepcopy(tchart)
    c4['bindto'] = '#chart-waypoints'
    c4['data']['columns'][0].append(waypoints)
    c4['data']['columns'][1].append(total - waypoints)

    c5 = copy.deepcopy(tchart)
    c5['bindto'] = '#chart-licenses'
    c5['data']['columns'][0].append(licenses)
    c5['data']['columns'][1].append(total - licenses)

    # Bar (filesize distribution)
    c6 = { 'bindto': '', 'data': { 'x': 'x', 'json': { }, 'type': 'bar' },
           'axis': { 'x': { 'type': 'category' } } }
    c6['bindto'] = '#chart-filesizes'
    c6['data']['json']["x"] = list(filesize_dist.keys())
    c6['data']['json']["size"] = list(filesize_dist.values())

    # Donut (gametypes)
    c7 = { 'bindto': '', 'data': { 'json': { }, 'type': 'donut' } }
    c7['bindto'] = '#chart-gametypes'
    gametypes_sorted = OrderedDict(sorted(gametypes_dist.items(), key=itemgetter(1), reverse=True))
    c7['data']['json'] = gametypes_sorted

    # Donut (dupes)
    c8 = { 'bindto': '', 'data': { 'json': { }, 'type': 'donut' } }
    c8['bindto'] = '#chart-shacount'
    shadupes_sorted = OrderedDict(sorted(shadupes_dist.items(), key=itemgetter(1), reverse=True))
    c8['data']['json'] = shadupes_sorted

    # Line (maps over time)
    c9 = { 'bindto': '', 'data': { 'x': 'x', 'json': { }, 'type': 'line' },
           'axis': { 'x': { 'type': 'indexed' } } }
    c9['bindto'] = '#chart-mapsbyyear'
    c9['data']['json']['x'] = list(maps_by_year.keys())
    c9['data']['json']['maps'] = list(maps_by_year.values())

    # Stacked Area (files over time)
    c10 = { 'bindto': '', 'data': { 'x': 'x', 'json': { }, 'type': 'area' },
           'axis': { 'x': { 'type': 'indexed' } } }
    c10['bindto'] = '#chart-filesbyyear'
    c10['data']['types'] = dict.fromkeys(files, 'area')
    c10['data']['groups'] = [files]
    c10['data']['json']['x'] = years

    for f in files:
        c10['data']['json'][f] = list(files_by_year[f].values())

    # Setup charts JSON
    charts = { 
                'mapinfos': c0,
                'mapshots': c1,
                'maps': c2,
                'radars': c3,
                'waypoints': c4,
                'licenses': c5,
                'filesizes': c6,
                'gametypes': c7,
                'shacount': c8,
                'mapsbyyear': c9,
                'filesbyyear': c10
             }

    fo = open('./resources/data/charts.json', 'w')
    fo.write(json.dumps(charts))
    fo.close()

def convertSize(num):
    for x in ['B','KB','MB','GB']:
        if num < 1024.0:
            return "%3.1d%s" % (num, x)
        num /= 1024.0
    return "%3.1f%s" % (num, 'TB')

if __name__ == "__main__":
    main()
